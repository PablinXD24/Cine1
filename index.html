<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineSync Pro - TransmissÃ£o P2P</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTÃ‰TICA APPLE PRO LIQUID GLASS --- */
        :root {
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent: #007AFF;
            --accent-glow: rgba(0, 122, 255, 0.4);
            --error: #FF3B30;
            --success: #32D74B;
            --border-radius: 24px;
        }
        
        body {
            margin: 0; font-family: 'Inter', sans-serif; background: #000;
            color: var(--text-primary); height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        
        /* FUNDO AURORA */
        .bg {
            position: fixed; inset: 0; z-index: -2;
            background: radial-gradient(circle at top left, #4F46E5, transparent 50%),
                        radial-gradient(circle at bottom right, #E11D48, transparent 50%),
                        radial-gradient(circle at center, #0F172A, #000000);
            background-size: 150% 150%;
        }
        /* Efeito Noise */
        .bg::after {
            content: ''; position: absolute; inset: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc0MDAnIGhlaWdodD0nNDAwJz48ZmlsdGVyIGlkPSdhJz48ZmVUdXJidWxlbmNlIHR5cGU9J2ZyYWN0YWxOb2lzZScgYmFzZUZyZXF1ZW5jeT0nLjYnIG51bU9jdGF2ZXM9JzMnIHN0aXRjaFRpbGVzPSdzdGl0Y2gnLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWx0ZXI9J3VybCgjYSknIG9wYWNpdHk9JzAuMDUnLz48L3N2Zz4=');
            opacity: 0.3; mix-blend-mode: overlay; z-index: -1;
        }

        /* GLASS PRO */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(50px) saturate(150%);
            -webkit-backdrop-filter: blur(50px) saturate(150%);
            border-radius: var(--border-radius);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1),
                        inset 1px 1px 2px 0 rgba(255, 255, 255, 0.2),
                        0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* UI ELEMENTS */
        input {
            padding: 18px 24px; border-radius: 18px; border: none;
            background: rgba(0, 0, 0, 0.2); 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.05);
            color: var(--text-primary); font-size: 1rem; outline: none; width: 100%; box-sizing: border-box; transition: 0.3s;
        }
        input:focus { background: rgba(0, 0, 0, 0.3); box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), inset 0 0 0 1px rgba(255,255,255,0.1), 0 0 0 3px var(--accent-glow); }

        button {
            padding: 18px 32px; border-radius: 18px; border: none;
            background: var(--accent); color: white; font-weight: 600; font-size: 1.05rem; cursor: pointer;
            transition: all 0.2s ease; box-shadow: 0 4px 15px var(--accent-glow);
        }
        button:hover { transform: scale(1.03); filter: brightness(1.1); }
        
        .btn-broadcast {
            background: var(--error); box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
            display: flex; align-items: center; gap: 10px; justify-content: center;
        }
        .btn-broadcast.active {
            background: var(--success); box-shadow: 0 4px 25px rgba(50, 215, 75, 0.5);
            animation: pulseSuccess 2s infinite;
        }
        @keyframes pulseSuccess { 0% { box-shadow: 0 0 0 0 rgba(50, 215, 75, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(50, 215, 75, 0); } 100% { box-shadow: 0 0 0 0 rgba(50, 215, 75, 0); } }

        .live-indicator { width: 10px; height: 10px; background: white; border-radius: 50%; display: none; }
        .btn-broadcast.active .live-indicator { display: block; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .btn-icon {
            background: rgba(255, 255, 255, 0.08); color: var(--text-primary); 
            padding: 18px; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
        }
        
        /* TOASTS */
        #toast-area { position: fixed; top: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap: 15px; pointer-events: none; }
        .toast { 
            pointer-events: auto; padding: 18px 24px; background: rgba(40, 40, 40, 0.8); backdrop-filter: blur(30px);
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5); 
            color: var(--text-primary); font-weight: 500; display: flex; align-items: center; gap: 12px; animation: slideIn 0.4s ease;
        }
        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* LAYOUT */
        #lobby { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); }
        .card-center { padding: 60px; width: 90%; max-width: 480px; text-align: center; display: flex; flex-direction: column; gap: 30px; }
        h1 { margin: 0; font-size: 3rem; font-weight: 800; background: linear-gradient(to bottom right, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        #app { display: none; height: 100%; padding: 30px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: 1fr 400px; grid-template-rows: auto 1fr; gap: 30px; height: 100%; max-width: 2000px; margin: 0 auto; }
        .controls { grid-column: 1 / -1; padding: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        
        .video-box { position: relative; background: #000; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.1); }
        
        /* PLAYERS */
        #stream-player { width: 100%; height: 100%; position: absolute; object-fit: contain; }
        #host-preview { display:none; width: 100%; height: 100%; position: absolute; object-fit: contain; }

        /* CHAT */
        .chat-box { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .chat-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: 700; }
        .msgs { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 15px; }
        .msg-bubble { background: rgba(255,255,255,0.07); padding: 14px 20px; border-radius: 22px; border-bottom-left-radius: 6px; font-size: 1rem; max-width: 85%; }
        .chat-input-area { padding: 24px; display: flex; gap: 16px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.15); }
        ::-webkit-scrollbar { width: 0px; }

        @media (max-width: 1024px) { 
            .grid { grid-template-columns: 1fr; grid-template-rows: auto 45vh 1fr; } 
            .controls { gap: 12px; } button { padding: 16px; }
        }
    </style>
</head>
<body>

    <div class="bg"></div>
    <div id="toast-area"></div>

    <div id="lobby">
        <div class="card-center glass">
            <h1>CineSync <span style="font-weight:300; color: var(--accent);">Live</span></h1>
            <p style="color:var(--text-secondary)">TransmissÃ£o de Tela P2P</p>
            <input type="text" id="userInput" placeholder="Seu Apelido">
            <input type="text" id="roomInput" placeholder="Nome da Sala">
            <button onclick="enterRoom()">Entrar</button>
        </div>
    </div>

    <div id="app">
        <div class="grid">
            <div class="controls glass">
                <div style="flex: 2; color: #aaa; font-size: 0.9rem;">
                    * Para transmitir, abra o filme em OUTRA ABA, clique em Transmitir e escolha aquela aba com Ã¡udio.
                </div>
                
                <button id="broadcastBtn" class="btn-broadcast" onclick="startBroadcast()" title="Compartilhar sua tela">
                    <div class="live-indicator"></div>
                    <span>ðŸ“¡ Transmitir Tela</span>
                </button>

                <button onclick="shareLink()" class="btn-icon">ðŸ”—</button>
            </div>
            
            <div class="video-box glass">
                <video id="host-preview" muted playsinline></video>
                <video id="stream-player" controls playsinline autoplay></video>
                
                <button id="unlock-btn" onclick="unlockAudio()" style="position:absolute; display:none; z-index:50; background:white; color:black;">ðŸ”Š Ativar Som da Live</button>
            </div>
            
            <div class="chat-box glass">
                <div class="chat-header">Bate-papo</div>
                <div class="msgs" id="chatList"></div>
                <div class="chat-input-area">
                    <input id="msgInput" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" class="btn-icon">âž¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÃ‡ÃƒO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAzUrQOJcALZmO9vyO8J52XDKL4Q49M7Rg",
            authDomain: "cine-54caf.firebaseapp.com",
            databaseURL: "https://cine-54caf-default-rtdb.firebaseio.com",
            projectId: "cine-54caf",
            storageBucket: "cine-54caf.firebasestorage.app",
            messagingSenderId: "345032163360",
            appId: "1:345032163360:web:7be1fca9c58250c2bf3c45"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomRef, user, peer, myStream;
        let isHost = false;
        
        // Elementos
        const streamPlayer = document.getElementById('stream-player');
        const hostPreview = document.getElementById('host-preview');
        const broadcastBtn = document.getElementById('broadcastBtn');
        const unlockBtn = document.getElementById('unlock-btn');

        function notify(msg, type='info') {
            const d = document.createElement('div');
            d.className = `toast`; d.innerText = msg;
            if(type==='error') d.style.borderLeft = '4px solid var(--error)';
            document.getElementById('toast-area').appendChild(d);
            setTimeout(() => d.remove(), 4000);
        }

        function enterRoom() {
            user = document.getElementById('userInput').value || 'Visitante';
            const room = document.getElementById('roomInput').value || 'geral';
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            const url = window.location.pathname + '?room=' + room;
            window.history.pushState({path: url}, '', url);

            roomRef = db.ref(`rooms/${room}`);
            
            // --- 2. CONFIGURAÃ‡ÃƒO DO PEERJS COM SERVIDORES STUN (CORREÃ‡ÃƒO DE CONEXÃƒO) ---
            peer = new Peer(undefined, {
                // ConfiguraÃ§Ã£o crucial para atravessar roteadores
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', id => {
                console.log('Meu ID:', id);
                roomRef.child('chat').push({user: 'ðŸ¤–', text: `${user} entrou.`});
                // ComeÃ§a a escutar se tem live
                listenForBroadcast();
            });

            // Se eu receber uma ligaÃ§Ã£o (sou convidado)
            peer.on('call', call => {
                call.answer(null); // Atende
                call.on('stream', remoteStream => {
                    notify("ðŸŽ¥ Recebendo vÃ­deo do Host...", "success");
                    showStream(remoteStream);
                });
                call.on('error', err => notify("Erro na conexÃ£o P2P: " + err, "error"));
            });

            setupChat();
        }

        // --- 3. LÃ“GICA DE TRANSMISSÃƒO (HOST) ---
        async function startBroadcast() {
            if(isHost) return stopBroadcast();

            try {
                // Captura Tela
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: true // IMPORTANTE: Captura som da aba
                });

                myStream = stream;
                isHost = true;
                
                // Mostra preview pro host (mudo para nÃ£o dar eco)
                hostPreview.srcObject = stream;
                hostPreview.style.display = 'block';
                hostPreview.play();
                streamPlayer.style.display = 'none';

                // Atualiza BotÃ£o
                broadcastBtn.classList.add('active');
                broadcastBtn.querySelector('span').innerText = 'Parar TransmissÃ£o';
                
                // Salva ID no Firebase para convidados conectarem
                roomRef.child('broadcast').set({
                    hostPeerId: peer.id,
                    isLive: true,
                    hostName: user
                });

                // Se parar pelo navegador
                stream.getVideoTracks()[0].onended = () => { stopBroadcast(); };
                
                // Lida com novas conexÃµes
                peer.on('connection', conn => {
                    // Quando alguÃ©m conecta, ligamos de volta com o stream
                    const call = peer.call(conn.peer, myStream);
                });

                notify("VocÃª estÃ¡ transmitindo! Abra o filme na outra aba.", "success");

            } catch (err) {
                console.error(err);
                notify("Erro ao iniciar: " + err.message, "error");
                stopBroadcast();
            }
        }

        function stopBroadcast() {
            if(myStream) myStream.getTracks().forEach(track => track.stop());
            broadcastBtn.classList.remove('active');
            broadcastBtn.querySelector('span').innerText = 'ðŸ“¡ Transmitir Tela';
            roomRef.child('broadcast').set({ isLive: false });
            hostPreview.style.display = 'none';
            isHost = false;
            notify("TransmissÃ£o encerrada.");
        }

        // --- 4. LÃ“GICA DE RECEPÃ‡ÃƒO (CONVIDADOS) ---
        function listenForBroadcast() {
            roomRef.child('broadcast').on('value', snap => {
                const data = snap.val();
                if (isHost) return; // Host ignora

                if (data && data.isLive && data.hostPeerId) {
                    if (data.hostPeerId !== peer.id) {
                        notify(`Conectando Ã  tela de ${data.hostName}...`);
                        // Conecta ao host para pedir o stream
                        const conn = peer.connect(data.hostPeerId);
                        conn.on('open', () => {
                            console.log("Conectado ao sinalizador do host.");
                        });
                    }
                } else {
                    streamPlayer.srcObject = null;
                    streamPlayer.style.display = 'none';
                }
            });
        }

        function showStream(stream) {
            hostPreview.style.display = 'none';
            streamPlayer.style.display = 'block';
            streamPlayer.srcObject = stream;
            
            const playPromise = streamPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    notify("Clique no botÃ£o para liberar o som!", "error");
                    unlockBtn.style.display = 'block';
                });
            }
        }

        function unlockAudio() {
            streamPlayer.play();
            unlockBtn.style.display = 'none';
        }

        // --- CHAT ---
        function setupChat() {
            roomRef.child('chat').on('child_added', snap => {
                const msg = snap.val();
                const d = document.createElement('div');
                d.className = 'msg-bubble';
                d.innerHTML = `<strong style="color:var(--accent); opacity:0.8;">${msg.user}</strong><br>${msg.text}`;
                document.getElementById('chatList').appendChild(d);
                document.getElementById('chatList').scrollTop = 99999;
            });
        }
        function sendMsg() {
            const i = document.getElementById('msgInput');
            if(i.value) roomRef.child('chat').push({ user, text: i.value });
            i.value = '';
        }
        function shareLink() { navigator.clipboard.writeText(window.location.href); notify("Link copiado!", "success"); }
    </script>
</body>
</html>
